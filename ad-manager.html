<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare Worker 广告管理平台</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { padding: 20px; max-width: 1200px; margin: 0 auto; background: #f5f5f5; }
        .tab-container { margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; border: none; background: #fff; cursor: pointer; border-bottom: 2px solid transparent; margin-right: 5px; }
        .tab-btn.active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: bold; }
        .tab-content { display: none; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        input, textarea, select { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        button { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #2563eb; color: #fff; }
        .btn-danger { background: #dc2626; color: #fff; }
        .btn-copy { background: #f3f4f6; color: #374151; margin-left: 10px; }
        .list-container { margin-top: 20px; }
        .list-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .list-item:last-child { border-bottom: none; }
        .item-info { flex: 1; min-width: 300px; margin-bottom: 10px; }
        .item-actions { display: flex; gap: 10px; }
        .alert { padding: 10px; margin-bottom: 15px; border-radius: 4px; font-size: 14px; }
        .alert-success { background: #ecfdf5; color: #059669; }
        .alert-error { background: #fee2e2; color: #dc2626; }
        .alert-info { background: #eff6ff; color: #2563eb; }
        .code-container { background: #f9fafb; padding: 15px; border-radius: 4px; border-left: 3px solid #2563eb; margin-top: 10px; }
        .code-title { font-weight: bold; margin-bottom: 5px; color: #374151; }
        textarea.code { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 4px; background: #fff; font-family: monospace; font-size: 13px; resize: none; min-height: 80px; }
        .callout { background: #fffbeb; border-left: 4px solid #f59e0b; padding: 10px 15px; margin: 10px 0; border-radius: 0 4px 4px 0; }
        .worker-url-group { background: #f0f9ff; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal.active { display: flex; }
        .modal-content { background: #fff; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-title { font-size: 18px; font-weight: bold; }
        .close-modal { background: none; border: none; font-size: 20px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Cloudflare Worker 广告管理平台</h1>

    <!-- Worker 地址配置 -->
    <div class="worker-url-group">
        <label>Worker 基础地址（例如：https://xxx.cloudflareworkers.com）：</label>
        <input type="text" id="workerBaseUrl" placeholder="https://你的Worker域名" value="">
        <button class="btn-primary" id="saveUrlBtn">保存地址</button>
        <div id="urlStatus" class="alert alert-info hidden">地址已保存，可开始使用系统功能</div>
    </div>

    <!-- 标签页切换 -->
    <div class="tab-container">
        <button class="tab-btn active" data-tab="placement-tab">广告位管理</button>
        <button class="tab-btn" data-tab="ad-tab">广告管理</button>
        <button class="tab-btn" data-tab="code-tab">广告调用代码</button>
    </div>

    <!-- 1. 广告位管理标签页 -->
    <div id="placement-tab" class="tab-content active">
        <!-- 新增广告位表单 -->
        <h3>新增广告位</h3>
        <div class="form-group">
            <label>广告位ID（唯一标识，如：sidebar-1，仅字母/数字/短横线）：</label>
            <input type="text" id="placementId" placeholder="输入广告位ID" pattern="[a-zA-Z0-9-]+" title="仅允许字母、数字和短横线">
        </div>
        <div class="form-group">
            <label>广告位名称（如：侧边栏广告位）：</label>
            <input type="text" id="placementName" placeholder="输入广告位名称">
        </div>
        <div class="form-group">
            <label>广告位描述（如：首页侧边栏，300x600px）：</label>
            <textarea id="placementDesc" rows="2" placeholder="输入广告位描述"></textarea>
        </div>
        <div class="form-group">
            <label>状态：</label>
            <select id="placementStatus">
                <option value="active">启用</option>
                <option value="inactive">禁用</option>
            </select>
        </div>
        <button class="btn-primary" id="addPlacementBtn">添加广告位</button>

        <!-- 广告位列表 -->
        <div class="list-container" id="placementList">
            <div class="alert">请先填写并保存Worker地址</div>
        </div>
    </div>

    <!-- 2. 广告管理标签页 -->
    <div id="ad-tab" class="tab-content">
        <!-- 新增广告表单 -->
        <h3>新增广告</h3>
        <div class="callout">
            <strong>注意：</strong>
            <ul style="margin-left: 20px; margin-top: 5px;">
                <li>图片广告：填写图片完整URL（如https://xxx.com/ad.jpg）</li>
                <li>文本广告：填写广告文本（支持简单HTML标签如&lt;a&gt;）</li>
                <li>HTML广告：填写完整HTML代码（需自行确保样式兼容）</li>
            </ul>
        </div>
        <div class="form-group">
            <label>广告名称（如：首页Banner广告）：</label>
            <input type="text" id="adName" placeholder="输入广告名称">
        </div>
        <div class="form-group">
            <label>广告类型：</label>
            <select id="adType">
                <option value="image">图片广告（输入图片URL）</option>
                <option value="text">文本广告（输入文本内容）</option>
                <option value="html">HTML广告（输入HTML代码）</option>
            </select>
            <div id="adTypeTip" class="callout hidden"></div>
        </div>
        <div class="form-group">
            <label>广告内容：</label>
            <textarea id="adContent" rows="4" placeholder="根据广告类型填写对应内容"></textarea>
        </div>
        <div class="form-group">
            <label>关联广告位（需先创建并启用）：</label>
            <select id="adPlacement">
                <option value="">请先保存Worker地址</option>
            </select>
        </div>
        <div class="form-group">
            <label>状态：</label>
            <select id="adStatus">
                <option value="active">启用</option>
                <option value="inactive">禁用</option>
            </select>
        </div>
        <button class="btn-primary" id="addAdBtn">添加广告</button>

        <!-- 广告列表 -->
        <div class="list-container" id="adList">
            <div class="alert">请先填写并保存Worker地址</div>
        </div>
    </div>

    <!-- 3. 广告调用代码标签页 -->
    <div id="code-tab" class="tab-content">
        <h3>广告调用代码生成</h3>
        <div class="form-group">
            <label>选择广告位：</label>
            <select id="codePlacement">
                <option value="">请先保存Worker地址</option>
            </select>
        </div>
        <div class="form-group">
            <label>调用方式：</label>
            <div>
                <label style="display: inline-block; margin-right: 20px;">
                    <input type="radio" name="codeType" value="script" checked> 脚本调用（推荐）
                </label>
                <label style="display: inline-block;">
                    <input type="radio" name="codeType" value="iframe"> iframe调用
                </label>
            </div>
        </div>
        <div id="codeResult" class="code-container hidden">
            <div class="code-title">广告调用代码（点击复制）</div>
            <textarea id="adCodeText" class="code" readonly></textarea>
            <div style="margin-top: 10px; text-align: right;">
                <button class="btn-copy" id="copyCodeBtn">复制代码</button>
            </div>
            <div class="callout" style="margin-top: 10px;">
                <strong>使用说明：</strong>
                <ul style="margin-left: 20px; margin-top: 5px;">
                    <li>将代码粘贴到需要显示广告的网页中</li>
                    <li>脚本调用：自动适应页面样式，支持动态加载</li>
                    <li>iframe调用：兼容性更强，适合复杂页面环境</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 广告添加成功弹窗 -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">广告添加成功</div>
                <button class="close-modal" id="modalCloseBtn">&times;</button>
            </div>
            <div>
                <p>广告已成功添加到广告位：<span id="successPlacement"></span></p>
                <div class="code-container" style="margin: 15px 0;">
                    <div class="code-title">该广告位调用代码</div>
                    <textarea id="successAdCode" class="code" readonly></textarea>
                </div>
                <div style="text-align: right;">
                    <button class="btn-copy" id="modalCopyBtn">复制代码</button>
                    <button class="btn-primary" style="margin-left: 10px;" id="modalConfirmBtn">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量初始化
        let codeEl, resultEl, successPlacementEl, successAdCodeEl, successModalEl;

        // -------------------------- 核心工具函数（最先定义，确保所有地方可调用） --------------------------
        // HTML转义函数（防止XSS和显示乱码）
        function escapeHtml(str) {
            if (typeof str !== 'string') return '';
            const entities = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;',
                '/': '&#x2F;'
            };
            return str.replace(/[&<>"'\/]/g, function(char) {
                return entities[char] || char;
            });
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化DOM元素引用
            initElements();
            
            // 绑定所有事件（避免使用onclick属性）
            bindEvents();
            
            // 初始化弹窗状态（确保隐藏）
            successModalEl.style.display = 'none';
            
            // 加载保存的Worker地址
            const savedUrl = getWorkerUrl();
            if (savedUrl) {
                document.getElementById('workerBaseUrl').value = savedUrl;
                document.getElementById('urlStatus').classList.remove('hidden');
                // 加载数据
                loadPlacementList();
                loadAdPlacementOptions();
                loadAdList();
                loadCodePlacementOptions();
            }
            
            // 显示广告类型提示
            showAdTypeTip();
        });

        // 初始化DOM元素
        function initElements() {
            codeEl = document.getElementById('adCodeText');
            resultEl = document.getElementById('codeResult');
            successPlacementEl = document.getElementById('successPlacement');
            successAdCodeEl = document.getElementById('successAdCode');
            successModalEl = document.getElementById('successModal');
        }

        // 绑定所有事件处理函数
        function bindEvents() {
            // 标签页切换
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // 保存Worker地址
            document.getElementById('saveUrlBtn').addEventListener('click', saveWorkerUrl);
            
            // 添加广告位
            document.getElementById('addPlacementBtn').addEventListener('click', addPlacement);
            
            // 添加广告
            document.getElementById('addAdBtn').addEventListener('click', addAd);
            
            // 广告类型切换提示
            document.getElementById('adType').addEventListener('change', showAdTypeTip);
            
            // 代码类型切换
            document.querySelectorAll('input[name="codeType"]').forEach(radio => {
                radio.addEventListener('change', generateAdCode);
            });
            
            // 广告位选择变化时生成代码
            document.getElementById('codePlacement').addEventListener('change', generateAdCode);
            
            // 复制代码按钮
            document.getElementById('copyCodeBtn').addEventListener('click', function() {
                copyAdCode('adCodeText');
            });
            
            // 弹窗关闭按钮
            document.getElementById('modalCloseBtn').addEventListener('click', function() {
                closeModal('successModal');
            });
            
            // 弹窗内复制按钮
            document.getElementById('modalCopyBtn').addEventListener('click', function() {
                copyAdCode('successAdCode');
            });
            
            // 弹窗内关闭按钮
            document.getElementById('modalConfirmBtn').addEventListener('click', function() {
                closeModal('successModal');
            });
            
            // 点击弹窗背景关闭
            successModalEl.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal('successModal');
                }
            });
        }

        // 存储和获取Worker地址
        function saveWorkerUrl() {
            const url = document.getElementById('workerBaseUrl').value.trim();
            if (!url) {
                alert('请输入有效的Worker地址！');
                return;
            }
            // 验证URL格式
            try {
                new URL(url);
            } catch (e) {
                alert('请输入有效的URL（如：https://xxx.cloudflareworkers.com）');
                return;
            }
            localStorage.setItem('workerBaseUrl', url);
            document.getElementById('urlStatus').classList.remove('hidden');
            // 刷新所有列表
            loadPlacementList();
            loadAdPlacementOptions();
            loadAdList();
            loadCodePlacementOptions();
        }

        function getWorkerUrl() {
            return localStorage.getItem('workerBaseUrl') || '';
        }

        // 标签页切换
        function switchTab(tabId) {
            // 切换按钮状态
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');
            
            // 切换内容显示
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
        }

        // 显示广告类型提示
        function showAdTypeTip() {
            const adType = document.getElementById('adType').value;
            const tipEl = document.getElementById('adTypeTip');
            tipEl.classList.remove('hidden');
            
            switch(adType) {
                case 'image':
                    tipEl.innerHTML = '图片广告示例：https://example.com/ad-banner.jpg<br>建议尺寸：根据广告位设计（如300x250px）';
                    break;
                case 'text':
                    tipEl.innerHTML = '文本广告示例：<a href="https://example.com" target="_blank">点击查看优惠活动</a><br>支持&lt;a&gt;、&lt;strong&gt;等简单HTML标签';
                    break;
                case 'html':
                    tipEl.innerHTML = 'HTML广告示例：<div style="padding:10px;background:#f5f5f5;"><a href="https://example.com">立即购买</a></div><br>需包含完整HTML结构，避免使用冲突样式名';
                    break;
            }
        }

        // -------------------------- 广告位相关功能 --------------------------
        // 加载广告位列表
        async function loadPlacementList() {
            const workerUrl = getWorkerUrl();
            if (!workerUrl) return;
            
            const listEl = document.getElementById('placementList');
            listEl.innerHTML = '<div class="alert">加载中...</div>';
            
            try {
                const res = await fetch(workerUrl + '/placement/list');
                const data = await res.json();
                
                if (!data.data || data.data.length === 0) {
                    listEl.innerHTML = '<div class="alert">暂无广告位数据，请先添加广告位</div>';
                    return;
                }
                
                let html = '';
                data.data.forEach(placement => {
                    html += '<div class="list-item">';
                    html += '<div class="item-info">';
                    html += '<strong>ID：' + escapeHtml(placement.id) + '</strong><br>';
                    html += '名称：' + escapeHtml(placement.name) + '<br>';
                    html += '描述：' + escapeHtml(placement.description) + '<br>';
                    html += '状态：' + (placement.status === 'active' ? 
                        '<span style="color:green">启用</span>' : 
                        '<span style="color:red">禁用</span>');
                    html += '</div>';
                    html += '<div class="item-actions">';
                    html += '<button class="btn-danger" onclick="deletePlacement(\'' + escapeHtml(placement.id) + '\')">删除</button>';
                    html += '</div>';
                    html += '</div>';
                });
                listEl.innerHTML = html;
            } catch (err) {
                listEl.innerHTML = '<div class="alert alert-error">加载失败：' + err.message + '</div>';
            }
        }

        // 新增广告位
        async function addPlacement() {
            const workerUrl = getWorkerUrl();
            if (!workerUrl) {
                alert('请先填写并保存Worker地址！');
                return;
            }
            
            const placement = {
                id: document.getElementById('placementId').value.trim(),
                name: document.getElementById('placementName').value.trim(),
                description: document.getElementById('placementDesc').value.trim(),
                status: document.getElementById('placementStatus').value
            };
            
            // 校验必填项
            if (!placement.id) {
                alert('请输入广告位ID（仅字母、数字、短横线）');
                return;
            }
            if (!placement.name) {
                alert('请输入广告位名称');
                return;
            }
            if (!placement.description) {
                alert('请输入广告位描述');
                return;
            }
            
            try {
                const res = await fetch(workerUrl + '/placement/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(placement)
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('广告位添加成功！');
                    // 清空表单
                    document.getElementById('placementId').value = '';
                    document.getElementById('placementName').value = '';
                    document.getElementById('placementDesc').value = '';
                    // 刷新列表
                    loadPlacementList();
                    loadAdPlacementOptions();
                    loadCodePlacementOptions();
                } else {
                    alert('添加失败：' + (data.error || '未知错误'));
                }
            } catch (err) {
                alert('添加失败：' + err.message);
            }
        }

        // 删除广告位
        async function deletePlacement(placementId) {
            const workerUrl = getWorkerUrl();
            if (!workerUrl) {
                alert('请先填写并保存Worker地址！');
                return;
            }
            
            if (!confirm('确定要删除广告位「' + placementId + '」吗？删除后关联的广告也将无法显示！')) {
                return;
            }
            
            try {
                const res = await fetch(workerUrl + '/placement/delete?placementId=' + placementId, {
                    method: 'DELETE'
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('广告位删除成功！');
                    // 刷新所有列表
                    loadPlacementList();
                    loadAdPlacementOptions();
                    loadCodePlacementOptions();
                    loadAdList();
                } else {
                    alert('删除失败：' + (data.error || '未知错误'));
                }
            } catch (err) {
                alert('删除失败：' + err.message);
            }
        }

        // -------------------------- 广告相关功能 --------------------------
        // 加载广告的广告位选项
        async function loadAdPlacementOptions() {
            const workerUrl = getWorkerUrl();
            if (!workerUrl) return;
            
            const selectEl = document.getElementById('adPlacement');
            selectEl.innerHTML = '<option value="">加载中...</option>';
            
            try {
                const res = await fetch(workerUrl + '/placement/list');
                const data = await res.json();
                
                if (!data.data || data.data.length === 0) {
                    selectEl.innerHTML = '<option value="">暂无可用广告位（需先创建并启用）</option>';
                    return;
                }
                
                // 只显示启用的广告位
                const activePlacements = data.data.filter(p => p.status === 'active');
                if (activePlacements.length === 0) {
                    selectEl.innerHTML = '<option value="">暂无启用的广告位（需先启用广告位）</option>';
                    return;
                }
                
                let html = '<option value="">请选择广告位</option>';
                activePlacements.forEach(p => {
                    html += '<option value="' + escapeHtml(p.id) + '">' + 
                        escapeHtml(p.name) + '（ID：' + escapeHtml(p.id) + '）</option>';
                });
                selectEl.innerHTML = html;
            } catch (err) {
                selectEl.innerHTML = '<option value="">加载失败：' + err.message + '</option>';
            }
        }

        // 加载广告列表
        async function loadAdList() {
            const workerUrl = getWorkerUrl();
            if (!workerUrl) return;
            
            const listEl = document.getElementById('adList');
            listEl.innerHTML = '<div class="alert">加载中...</div>';
            
            try {
                const res = await fetch(workerUrl + '/ad/list');
                const data = await res.json();
                
                if (!data.data || data.data.length === 0) {
                    listEl.innerHTML = '<div class="alert">暂无广告数据，请先添加广告</div>';
                    return;
                }
                
                let html = '';
                data.data.forEach(ad => {
                    // 过滤掉广告位数据（只显示广告）
                    if (ad.placement) {
                        html += '<div class="list-item">';
                        html += '<div class="item-info">';
                        html += '<strong>名称：' + escapeHtml(ad.name) + '</strong><br>';
                        html += '类型：' + getAdTypeName(ad.type) + '<br>';
                        html += '广告位：' + escapeHtml(ad.placement) + '<br>';
                        html += '状态：' + (ad.status === 'active' ? 
                            '<span style="color:green">启用</span>' : 
                            '<span style="color:red">禁用</span>') + '<br>';
                        html += '展示量：' + (ad.impressions || 0) + ' | 点击量：' + (ad.clicks || 0);
                        html += '</div>';
                        html += '<div class="item-actions">';
                        html += '<button class="btn-danger" onclick="deleteAd(\'' + escapeHtml(ad.id) + '\')">删除</button>';
                        html += '</div>';
                        html += '</div>';
                    }
                });
                listEl.innerHTML = html;
            } catch (err) {
                listEl.innerHTML = '<div class="alert alert-error">加载失败：' + err.message + '</div>';
            }
        }

        // 新增广告
        async function addAd() {
            const workerUrl = getWorkerUrl();
            if (!workerUrl) {
                alert('请先填写并保存Worker地址！');
                return;
            }
            
            const ad = {
                name: document.getElementById('adName').value.trim(),
                type: document.getElementById('adType').value,
                content: document.getElementById('adContent').value.trim(),
                placement: document.getElementById('adPlacement').value,
                status: document.getElementById('adStatus').value
            };
            
            // 校验必填项
            if (!ad.name) {
                alert('请输入广告名称');
                return;
            }
            if (!ad.content) {
                alert('请输入广告内容');
                return;
            }
            if (!ad.placement) {
                alert('请选择关联的广告位');
                return;
            }
            // 图片广告额外校验
            if (ad.type === 'image' && !ad.content.startsWith('http')) {
                if (!confirm('图片URL似乎不是完整链接，是否继续？')) {
                    return;
                }
            }
            
            try {
                const res = await fetch(workerUrl + '/ad/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ad)
                });
                const data = await res.json();
                
                if (data.success) {
                    // 清空表单
                    document.getElementById('adName').value = '';
                    document.getElementById('adContent').value = '';
                    // 刷新广告列表
                    loadAdList();
                    // 显示成功弹窗（含调用代码）
                    showSuccessModal(ad.placement);
                } else {
                    alert('添加失败：' + (data.error || '未知错误'));
                }
            } catch (err) {
                alert('添加失败：' + err.message);
            }
        }

        // 删除广告
        async function deleteAd(adId) {
            const workerUrl = getWorkerUrl();
            if (!workerUrl) {
                alert('请先填写并保存Worker地址！');
                return;
            }
            
            if (!confirm('确定要删除该广告吗？')) {
                return;
            }
            
            try {
                const res = await fetch(workerUrl + '/ad/delete?id=' + adId, {
                    method: 'DELETE'
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('广告删除成功！');
                    loadAdList();
                } else {
                    alert('删除失败：' + (data.error || '未知错误'));
                }
            } catch (err) {
                alert('删除失败：' + err.message);
            }
        }

        // 获取广告类型名称
        function getAdTypeName(type) {
            switch(type) {
                case 'image': return '图片广告';
                case 'text': return '文本广告';
                case 'html': return 'HTML广告';
                default: return type;
            }
        }

        // -------------------------- 广告调用代码功能 --------------------------
        // 加载代码页的广告位选项
        async function loadCodePlacementOptions() {
            const workerUrl = getWorkerUrl();
            if (!workerUrl) return;
            
            const selectEl = document.getElementById('codePlacement');
            selectEl.innerHTML = '<option value="">加载中...</option>';
            
            try {
                const res = await fetch(workerUrl + '/placement/list');
                const data = await res.json();
                
                if (!data.data || data.data.length === 0) {
                    selectEl.innerHTML = '<option value="">暂无广告位数据</option>';
                    return;
                }
                
                let html = '<option value="">请选择广告位</option>';
                data.data.forEach(p => {
                    const statusText = p.status === 'active' ? '（启用）' : '（禁用）';
                    html += '<option value="' + escapeHtml(p.id) + '">' + 
                        escapeHtml(p.name) + statusText + '</option>';
                });
                selectEl.innerHTML = html;
            } catch (err) {
                selectEl.innerHTML = '<option value="">加载失败：' + err.message + '</option>';
            }
        }

        // 生成广告调用代码
        function generateAdCode() {
            const workerUrl = getWorkerUrl();
            if (!workerUrl || !codeEl || !resultEl) return;
            
            const placementSelect = document.getElementById('codePlacement');
            const placementId = placementSelect.value;
            if (!placementId) {
                resultEl.classList.add('hidden');
                return;
            }
            
            // 获取选中的代码类型
            let codeType = 'script';
            const radioButtons = document.getElementsByName('codeType');
            for (let i = 0; i < radioButtons.length; i++) {
                if (radioButtons[i].checked) {
                    codeType = radioButtons[i].value;
                    break;
                }
            }
            
            // 生成代码
            const encodedPlacement = encodeURIComponent(placementId);
            let code = '';
            
            if (codeType === 'script') {
                code = '<script src="' + workerUrl + '/ad/embed?placement=' + encodedPlacement + '"><' + '/script>';
            } else {
                code = '<iframe src="' + workerUrl + '/ad/show?placement=' + encodedPlacement + '&format=html" width="100%" height="auto" frameborder="0" scrolling="no"></iframe>';
            }
            
            codeEl.value = code;
            resultEl.classList.remove('hidden');
        }

        // 复制广告代码
        function copyAdCode(elementId) {
            const codeEl = document.getElementById(elementId);
            if (!codeEl) {
                alert('复制失败：未找到代码容器');
                return;
            }
            
            try {
                codeEl.select();
                // 兼容现代浏览器
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(codeEl.value).then(function() {
                        alert('代码已复制到剪贴板');
                    }).catch(function(err) {
                        console.error('剪贴板API失败:', err);
                        fallbackCopy(codeEl);
                    });
                } else {
                    fallbackCopy(codeEl);
                }
            } catch (err) {
                alert('复制失败: ' + err.message);
            }
        }

        // 复制功能降级处理
        function fallbackCopy(element) {
            try {
                const successful = document.execCommand('copy');
                alert(successful ? '代码已复制到剪贴板' : '复制失败，请手动复制');
            } catch (err) {
                alert('复制失败，请手动复制');
            }
        }

        // -------------------------- 弹窗功能 --------------------------
        // 显示添加成功弹窗
        function showSuccessModal(placementId) {
            const workerUrl = getWorkerUrl();
            if (!workerUrl || !placementId || !successModalEl) return;
            
            // 获取广告位名称
            const placementSelect = document.getElementById('adPlacement');
            let placementName = placementId;
            for (let i = 0; i < placementSelect.options.length; i++) {
                if (placementSelect.options[i].value === placementId) {
                    placementName = placementSelect.options[i].text;
                    break;
                }
            }
            
            // 生成代码
            const encodedPlacement = encodeURIComponent(placementId);
            const code = '<script src="' + workerUrl + '/ad/embed?placement=' + encodedPlacement + '"><' + '/script>';
            
            // 设置弹窗内容
            successPlacementEl.textContent = placementName;
            successAdCodeEl.value = code;
            
            // 显示弹窗
            successModalEl.style.display = 'flex';
        }

        // 关闭弹窗
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                // 重置内容
                if (modalId === 'successModal') {
                    successPlacementEl.textContent = '';
                    successAdCodeEl.value = '';
                }
            }
        }

        // 全局函数声明（供HTML中onclick调用）
        window.deletePlacement = deletePlacement;
        window.deleteAd = deleteAd;
    </script>
</body>
</html>
